<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Ondas</title>
    <link rel="shortcut icon" href="assets/images/iconapp.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="assets/style.css">
</head>
<body class="body-waves">
    <div class="wrapper">
       <header>
        <nav>
            <ul>
                <li><a href="index.html">Generador de progresiones</a></li>
                <li><a href="Index2.html">Generador de partituras</a></li>
                <li><a href="#" class="active-nav-link">Generador de ondas</a></li>
                <li><a href="index4.html">Círculo de quintas</a></li>
                <li><a href="index5.html">Generador de cifrados</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <div id="global-controls-container">
            <div class="control-row">
                <label for="master-volume-slider">Volumen General</label>
                <input type="range" id="master-volume-slider" min="-40" max="0" value="-6" step="1">
            </div>
            <div class="control-row">
                <label for="piano-count-selector">Cantidad de Pianos</label>
                <select id="piano-count-selector">
                    <option value="1" selected>1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                </select>
            </div>
        </div>

        <!-- Piano 1 -->
        <div class="piano-wrapper" id="piano-1">
            <div class="piano-container">
                <svg class="piano-svg" viewBox="0 0 980 200">
                    <rect class="white-key" x="0" y="0" width="70" height="200" data-note="C4"/>
                    <rect class="white-key" x="70" y="0" width="70" height="200" data-note="D4"/>
                    <rect class="white-key" x="140" y="0" width="70" height="200" data-note="E4"/>
                    <rect class="white-key" x="210" y="0" width="70" height="200" data-note="F4"/>
                    <rect class="white-key" x="280" y="0" width="70" height="200" data-note="G4"/>
                    <rect class="white-key" x="350" y="0" width="70" height="200" data-note="A4"/>
                    <rect class="white-key" x="420" y="0" width="70" height="200" data-note="B4"/>
                    <rect class="white-key" x="490" y="0" width="70" height="200" data-note="C5"/>
                    <rect class="white-key" x="560" y="0" width="70" height="200" data-note="D5"/>
                    <rect class="white-key" x="630" y="0" width="70" height="200" data-note="E5"/>
                    <rect class="white-key" x="700" y="0" width="70" height="200" data-note="F5"/>
                    <rect class="white-key" x="770" y="0" width="70" height="200" data-note="G5"/>
                    <rect class="white-key" x="840" y="0" width="70" height="200" data-note="A5"/>
                    <rect class="white-key" x="910" y="0" width="70" height="200" data-note="B5"/>
                    <rect class="black-key" x="45" y="0" width="40" height="120" data-note="C#4"/>
                    <rect class="black-key" x="115" y="0" width="40" height="120" data-note="D#4"/>
                    <rect class="black-key" x="255" y="0" width="40" height="120" data-note="F#4"/>
                    <rect class="black-key" x="325" y="0" width="40" height="120" data-note="G#4"/>
                    <rect class="black-key" x="395" y="0" width="40" height="120" data-note="A#4"/>
                    <rect class="black-key" x="535" y="0" width="40" height="120" data-note="C#5"/>
                    <rect class="black-key" x="605" y="0" width="40" height="120" data-note="D#5"/>
                    <rect class="black-key" x="745" y="0" width="40" height="120" data-note="F#5"/>
                    <rect class="black-key" x="815" y="0" width="40" height="120" data-note="G#5"/>
                    <rect class="black-key" x="885" y="0" width="40" height="120" data-note="A#5"/>
                </svg>
            </div>
        </div>

        <!-- Piano 2 -->
        <div class="piano-wrapper" id="piano-2">
            <div class="piano-container">
                <svg class="piano-svg" viewBox="0 0 980 200">
                    <rect class="white-key" x="0" y="0" width="70" height="200" data-note="C4"/>
                    <rect class="white-key" x="70" y="0" width="70" height="200" data-note="D4"/>
                    <rect class="white-key" x="140" y="0" width="70" height="200" data-note="E4"/>
                    <rect class="white-key" x="210" y="0" width="70" height="200" data-note="F4"/>
                    <rect class="white-key" x="280" y="0" width="70" height="200" data-note="G4"/>
                    <rect class="white-key" x="350" y="0" width="70" height="200" data-note="A4"/>
                    <rect class="white-key" x="420" y="0" width="70" height="200" data-note="B4"/>
                    <rect class="white-key" x="490" y="0" width="70" height="200" data-note="C5"/>
                    <rect class="white-key" x="560" y="0" width="70" height="200" data-note="D5"/>
                    <rect class="white-key" x="630" y="0" width="70" height="200" data-note="E5"/>
                    <rect class="white-key" x="700" y="0" width="70" height="200" data-note="F5"/>
                    <rect class="white-key" x="770" y="0" width="70" height="200" data-note="G5"/>
                    <rect class="white-key" x="840" y="0" width="70" height="200" data-note="A5"/>
                    <rect class="white-key" x="910" y="0" width="70" height="200" data-note="B5"/>
                    <rect class="black-key" x="45" y="0" width="40" height="120" data-note="C#4"/>
                    <rect class="black-key" x="115" y="0" width="40" height="120" data-note="D#4"/>
                    <rect class="black-key" x="255" y="0" width="40" height="120" data-note="F#4"/>
                    <rect class="black-key" x="325" y="0" width="40" height="120" data-note="G#4"/>
                    <rect class="black-key" x="395" y="0" width="40" height="120" data-note="A#4"/>
                    <rect class="black-key" x="535" y="0" width="40" height="120" data-note="C#5"/>
                    <rect class="black-key" x="605" y="0" width="40" height="120" data-note="D#5"/>
                    <rect class="black-key" x="745" y="0" width="40" height="120" data-note="F#5"/>
                    <rect class="black-key" x="815" y="0" width="40" height="120" data-note="G#5"/>
                    <rect class="black-key" x="885" y="0" width="40" height="120" data-note="A#5"/>
                </svg>
            </div>
        </div>

        <!-- Piano 3 -->
        <div class="piano-wrapper" id="piano-3">
            <div class="piano-container">
                <svg class="piano-svg" viewBox="0 0 980 200">
                    <rect class="white-key" x="0" y="0" width="70" height="200" data-note="C4"/>
                    <rect class="white-key" x="70" y="0" width="70" height="200" data-note="D4"/>
                    <rect class="white-key" x="140" y="0" width="70" height="200" data-note="E4"/>
                    <rect class="white-key" x="210" y="0" width="70" height="200" data-note="F4"/>
                    <rect class="white-key" x="280" y="0" width="70" height="200" data-note="G4"/>
                    <rect class="white-key" x="350" y="0" width="70" height="200" data-note="A4"/>
                    <rect class="white-key" x="420" y="0" width="70" height="200" data-note="B4"/>
                    <rect class="white-key" x="490" y="0" width="70" height="200" data-note="C5"/>
                    <rect class="white-key" x="560" y="0" width="70" height="200" data-note="D5"/>
                    <rect class="white-key" x="630" y="0" width="70" height="200" data-note="E5"/>
                    <rect class="white-key" x="700" y="0" width="70" height="200" data-note="F5"/>
                    <rect class="white-key" x="770" y="0" width="70" height="200" data-note="G5"/>
                    <rect class="white-key" x="840" y="0" width="70" height="200" data-note="A5"/>
                    <rect class="white-key" x="910" y="0" width="70" height="200" data-note="B5"/>
                    <rect class="black-key" x="45" y="0" width="40" height="120" data-note="C#4"/>
                    <rect class="black-key" x="115" y="0" width="40" height="120" data-note="D#4"/>
                    <rect class="black-key" x="255" y="0" width="40" height="120" data-note="F#4"/>
                    <rect class="black-key" x="325" y="0" width="40" height="120" data-note="G#4"/>
                    <rect class="black-key" x="395" y="0" width="40" height="120" data-note="A#4"/>
                    <rect class="black-key" x="535" y="0" width="40" height="120" data-note="C#5"/>
                    <rect class="black-key" x="605" y="0" width="40" height="120" data-note="D#5"/>
                    <rect class="black-key" x="745" y="0" width="40" height="120" data-note="F#5"/>
                    <rect class="black-key" x="815" y="0" width="40" height="120" data-note="G#5"/>
                    <rect class="black-key" x="885" y="0" width="40" height="120" data-note="A#5"/>
                </svg>
            </div>
        </div>

        <!-- Piano 4 -->
        <div class="piano-wrapper" id="piano-4">
            <div class="piano-container">
                <svg class="piano-svg" viewBox="0 0 980 200">
                    <rect class="white-key" x="0" y="0" width="70" height="200" data-note="C4"/>
                    <rect class="white-key" x="70" y="0" width="70" height="200" data-note="D4"/>
                    <rect class="white-key" x="140" y="0" width="70" height="200" data-note="E4"/>
                    <rect class="white-key" x="210" y="0" width="70" height="200" data-note="F4"/>
                    <rect class="white-key" x="280" y="0" width="70" height="200" data-note="G4"/>
                    <rect class="white-key" x="350" y="0" width="70" height="200" data-note="A4"/>
                    <rect class="white-key" x="420" y="0" width="70" height="200" data-note="B4"/>
                    <rect class="white-key" x="490" y="0" width="70" height="200" data-note="C5"/>
                    <rect class="white-key" x="560" y="0" width="70" height="200" data-note="D5"/>
                    <rect class="white-key" x="630" y="0" width="70" height="200" data-note="E5"/>
                    <rect class="white-key" x="700" y="0" width="70" height="200" data-note="F5"/>
                    <rect class="white-key" x="770" y="0" width="70" height="200" data-note="G5"/>
                    <rect class="white-key" x="840" y="0" width="70" height="200" data-note="A5"/>
                    <rect class="white-key" x="910" y="0" width="70" height="200" data-note="B5"/>
                    <rect class="black-key" x="45" y="0" width="40" height="120" data-note="C#4"/>
                    <rect class="black-key" x="115" y="0" width="40" height="120" data-note="D#4"/>
                    <rect class="black-key" x="255" y="0" width="40" height="120" data-note="F#4"/>
                    <rect class="black-key" x="325" y="0" width="40" height="120" data-note="G#4"/>
                    <rect class="black-key" x="395" y="0" width="40" height="120" data-note="A#4"/>
                    <rect class="black-key" x="535" y="0" width="40" height="120" data-note="C#5"/>
                    <rect class="black-key" x="605" y="0" width="40" height="120" data-note="D#5"/>
                    <rect class="black-key" x="745" y="0" width="40" height="120" data-note="F#5"/>
                    <rect class="black-key" x="815" y="0" width="40" height="120" data-note="G#5"/>
                    <rect class="black-key" x="885" y="0" width="40" height="120" data-note="A#5"/>
                </svg>
            </div>
        </div>
    </main>
  
    <script src="https://unpkg.com/tone@14.7.58/build/Tone.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Global Controls ---
            const masterVolume = new Tone.Volume(-6).toDestination();
            const masterVolumeSlider = document.getElementById('master-volume-slider');
            masterVolumeSlider.addEventListener('input', (event) => {
                masterVolume.volume.value = event.target.value;
            });

            const pianoSelector = document.getElementById('piano-count-selector');
            const pianoWrappers = document.querySelectorAll('.piano-wrapper');

            function updateVisiblePianos(count) {
                pianoWrappers.forEach((wrapper, index) => {
                    if (index < count) {
                        wrapper.classList.remove('hidden');
                    } else {
                        wrapper.classList.add('hidden');
                    }
                });
            }

            pianoSelector.addEventListener('change', (e) => updateVisiblePianos(e.target.value));
            
            // Set initial state
            updateVisiblePianos(1);

            // --- Piano Instance Logic ---
            const createPianoInstance = (pianoWrapper) => {
                let activeNote = {
                    noteName: null,
                    originalDataNote: null,
                    synth: null
                };
                let currentWaveform = 'sine'; // Default waveform

                const startDrone = (noteName, originalDataNote) => {
                    if (activeNote.synth) stopDrone();
                    
                    activeNote.noteName = noteName;
                    activeNote.originalDataNote = originalDataNote;
                    activeNote.synth = new Tone.Synth({
                        oscillator: { type: currentWaveform },
                        envelope: { attack: 0.5, decay: 0.1, sustain: 1.0, release: 1.0 }
                    }).connect(masterVolume);

                    const volumeControl = pianoWrapper.querySelector('.piano-volume');
                    activeNote.synth.volume.value = volumeControl.value;

                    activeNote.synth.triggerAttack(noteName);
                    if (Tone.Transport.state !== 'started') Tone.Transport.start();
                    
                    const keyElement = pianoWrapper.querySelector(`[data-note="${originalDataNote}"]`);
                    if (keyElement) keyElement.classList.add('active');
                };

                const stopDrone = () => {
                    if (activeNote.synth) {
                        const keyElement = pianoWrapper.querySelector(`[data-note="${activeNote.originalDataNote}"]`);
                        if(keyElement) keyElement.classList.remove('active');

                        activeNote.synth.triggerRelease();
                        activeNote.synth.dispose();
                        
                        activeNote.noteName = null;
                        activeNote.originalDataNote = null;
                        activeNote.synth = null;
                    }
                };

                const noteButtons = pianoWrapper.querySelectorAll('rect[data-note]');
                noteButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const fullNote = button.getAttribute('data-note'); // e.g., "C#4"
                        const match = fullNote.match(/^([A-G]#?b?)(\d+)$/);

                        if (match) {
                            const baseNote = match[1];      // e.g., "C#"
                            const svgOctave = parseInt(match[2]); // e.g., 4

                            const octaveOffset = svgOctave - 4; // 0 for 1st octave on svg, 1 for 2nd

                            const selector = pianoWrapper.querySelector('.octave-selector');
                            const startingOctave = parseInt(selector.value); // 1, 3, or 5

                            const finalOctave = startingOctave + octaveOffset;
                            const noteName = baseNote + finalOctave;

                            if (activeNote.noteName === noteName) {
                                stopDrone();
                            } else {
                                startDrone(noteName, fullNote);
                            }
                        } else {
                            console.error("Formato de data-note inválido:", fullNote);
                        }
                    });
                });

                // Create and append Volume control
                const pianoVolumeControl = document.createElement('input');
                pianoVolumeControl.type = 'range';
                pianoVolumeControl.className = 'piano-volume';
                pianoVolumeControl.min = '-30';
                pianoVolumeControl.max = '0';
                pianoVolumeControl.value = '-6';
                pianoVolumeControl.addEventListener('input', (event) => {
                    if(activeNote.synth) activeNote.synth.volume.value = event.target.value;
                });

                const volumeContainer = document.createElement('div');
                volumeContainer.className = 'volume-control-container';
                const volumeLabel = document.createElement('label');
                volumeLabel.innerText = 'Volumen';
                volumeContainer.appendChild(volumeLabel);
                volumeContainer.appendChild(pianoVolumeControl);
                
                // Create and append Octave selector
                const octaveControlContainer = document.createElement('div');
                octaveControlContainer.className = 'octave-control-container';
                const octaveLabel = document.createElement('label');
                octaveLabel.innerText = 'Octava';
                const octaveSelectorEl = document.createElement('select');
                octaveSelectorEl.className = 'octave-selector';
                const octaveRanges = { "1": "1-2", "3": "3-4", "5": "5-6" };
                for (const startOctave in octaveRanges) {
                    const option = document.createElement('option');
                    option.value = startOctave;
                    option.innerText = octaveRanges[startOctave];
                    if (startOctave === "3") option.selected = true; // Default to 3-4
                    octaveSelectorEl.appendChild(option);
                }
                octaveControlContainer.appendChild(octaveLabel);
                octaveControlContainer.appendChild(octaveSelectorEl);

                const controlsWrapper = document.createElement('div');
                controlsWrapper.className = 'piano-controls-wrapper';
                
                // Waveform buttons
                const waveformButtons = document.createElement('div');
                waveformButtons.className = 'waveform-buttons';
                const waveforms = ['sine', 'square', 'sawtooth', 'triangle'];
                const waveSVGs = {
                    sine: '<svg viewBox="0 0 32 32" width="24" height="24" fill="none" stroke="currentColor" stroke-width="3"><path d="M 0 16 C 8 0, 24 32, 32 16"></path></svg>',
                    square: '<svg viewBox="0 0 32 32" width="24" height="24" fill="none" stroke="currentColor" stroke-width="3"><path d="M 0 16 H 8 V 8 H 24 V 24 H 32"></path></svg>',
                    sawtooth: '<svg viewBox="0 0 32 32" width="24" height="24" fill="none" stroke="currentColor" stroke-width="3"><path d="M 0 24 L 16 8 L 16 24 L 32 8"></path></svg>',
                    triangle: '<svg viewBox="0 0 32 32" width="24" height="24" fill="none" stroke="currentColor" stroke-width="3"><path d="M 0 16 L 8 8 L 24 24 L 32 16"></path></svg>'
                };
                waveforms.forEach(wave => {
                    const button = document.createElement('button');
                    button.className = 'waveform-button';
                    button.dataset.waveform = wave;
                    button.title = wave.charAt(0).toUpperCase() + wave.slice(1);
                    button.innerHTML = waveSVGs[wave];
                    if (wave === currentWaveform) button.classList.add('active');
                    button.addEventListener('click', () => {
                        currentWaveform = wave;
                        waveformButtons.querySelectorAll('.waveform-button').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        if (activeNote.noteName) {
                            const playingNote = activeNote.noteName;
                            const originalNote = activeNote.originalDataNote;
                            stopDrone();
                            startDrone(playingNote, originalNote);
                        }
                    });
                    waveformButtons.appendChild(button);
                });

                controlsWrapper.appendChild(waveformButtons);
                controlsWrapper.appendChild(volumeContainer);
                controlsWrapper.appendChild(octaveControlContainer);

                const pianoContainer = pianoWrapper.querySelector('.piano-container');
                pianoWrapper.insertBefore(controlsWrapper, pianoContainer);
            };

            document.querySelectorAll('.piano-wrapper').forEach(createPianoInstance);
        });
    </script>
</body>
</html>