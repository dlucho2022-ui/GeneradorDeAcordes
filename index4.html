<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circulo de Quintas</title>
    <link rel="shortcut icon" href="assets/images/iconapp.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/cards.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        .circle-container {
            position: relative; width: 750px; height: 750px; margin: 50px auto;
            display: flex; justify-content: center; align-items: center;
        }
        .key-base {
            position: absolute; border-radius: 50%; display: flex; justify-content: center;
            align-items: center; cursor: pointer; user-select: none; background-color: #2c2c2c;
            border: 2px solid #444;
            transition: transform 0.7s cubic-bezier(0.645, 0.045, 0.355, 1), 
                        border-color 0.3s, box-shadow 0.3s;
        }
        .key-base:hover {
            border-color: #bb86fc;
            transform: var(--transform-pos) scale(1.1);
        }
        .key-base.diatonic {
            border: 3px solid #bb86fc;
            box-shadow: 0 0 20px 3px rgba(187, 134, 252, 0.5);
        }
        .key-major { width: 130px; height: 130px; font-size: 2em; color: #f0f0f0; }
        .key-minor { width: 100px; height: 100px; font-size: 1.6em; color: #e0e0e0; }
        .key-diminished { width: 75px; height: 75px; font-size: 1.2em; color: #b0b0b0; }

        .key-major.active { background-color: #6a0dad; color: #f0f0f0; }
        .key-minor.active { background-color: #9370db; color: #f0f0f0; }
        .key-diminished.active { background-color: #ff6347; color: #f0f0f0; }

        .center-controls { z-index: 10; text-align: center; }
        .center-controls label { font-size: 1.2em; margin-bottom: 10px; display: block; color: #e0e0e0; }
        .center-controls select {
            font-size: 1.2em; padding: 5px; border-radius: 5px; background-color: #212121;
            color: #f0f0f0; border: 1px solid #444;
        }
        #floating-play-stop-button-circle {
            position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px;
            background-color: #198754; color: white; border-radius: 50%; border: none;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 1001;
        }
        #floating-play-stop-button-circle.playing { background-color: #dc3545; }
    </style>
</head>
<body>
<div class="wrapper">
    <header>
        <nav>
            <ul>
                <li><a href="index.html">Generador de progresiones</a></li>
                <li><a href="Index2.html">Generador de partituras</a></li>
                <li><a href="Index3.html">Generador de ondas</a></li>
                <li><a href="index4.html" class="active-nav-link">circulo de quintas</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <div class="circle-container" id="circle-of-fifths"></div>
        <div id="progression-container" class="progression-section">
            <h2>Progresión de Acordes</h2>
            <div id="progression-builder" class="progression-builder"></div>
            <div class="progression-controls">
                <button id="clear-progression-btn" class="control-button">Limpiar</button>
            </div>
        </div>
    </main>
</div>
<button id="floating-play-stop-button-circle" class="button">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M8 5v14l11-7z"/></svg>
</button>
<footer><p> </p></footer>
<script>
document.addEventListener('DOMContentLoaded', () => {
    document.body.addEventListener('click', () => { if (Tone.context.state !== 'running') Tone.start(); }, { once: true });

    const sampler = new Tone.Sampler({
        urls: { 'C4':'C4.mp3','D#4':'Ds4.mp3','F#4':'Fs4.mp3','A4':'A4.mp3' },
        release: 0.5, baseUrl: "https://tonejs.github.io/audio/salamander/",
    }).toDestination();

    const circleContainer = document.getElementById('circle-of-fifths');
    const progressionBuilder = document.getElementById('progression-builder');
    const clearProgressionBtn = document.getElementById('clear-progression-btn');
    const playStopBtn = document.getElementById('floating-play-stop-button-circle');
    const playIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M8 5v14l11-7z"/></svg>`;
    const stopIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M6 6h12v12H6z"/></svg>`;

    const keysData = [
        { pitch: 0, sharp: { major: 'C', minor: 'Am', diminished: 'B' }, flat: { major: 'C', minor: 'Am', diminished: 'B' } },
        { pitch: 7, sharp: { major: 'G', minor: 'Em', diminished: 'F#' }, flat: { major: 'G', minor: 'Em', diminished: 'F#' } },
        { pitch: 2, sharp: { major: 'D', minor: 'Bm', diminished: 'C#' }, flat: { major: 'D', minor: 'Bm', diminished: 'C#' } },
        { pitch: 9, sharp: { major: 'A', minor: 'F#m', diminished: 'G#' }, flat: { major: 'A', minor: 'F#m', diminished: 'G#' } },
        { pitch: 4, sharp: { major: 'E', minor: 'C#m', diminished: 'D#' }, flat: { major: 'E', minor: 'C#m', diminished: 'D#' } },
        { pitch: 11, sharp: { major: 'B', minor: 'G#m', diminished: 'A#' }, flat: { major: 'Cb', minor: 'Abm', diminished: 'Bb' } },
        { pitch: 6, sharp: { major: 'F#', minor: 'D#m', diminished: 'E#' }, flat: { major: 'Gb', minor: 'Ebm', diminished: 'F' } },
        { pitch: 1, sharp: { major: 'C#', minor: 'A#m', diminished: 'B#' }, flat: { major: 'Db', minor: 'Bbm', diminished: 'C' } },
        { pitch: 8, sharp: { major: 'G#', minor: 'Fm', diminished: 'G' }, flat: { major: 'Ab', minor: 'Fm', diminished: 'G' } },
        { pitch: 3, sharp: { major: 'D#', minor: 'Cm', diminished: 'D' }, flat: { major: 'Eb', minor: 'Cm', diminished: 'D' } },
        { pitch: 10, sharp: { major: 'A#', minor: 'Gm', diminished: 'A' }, flat: { major: 'Bb', minor: 'Gm', diminished: 'A' } },
        { pitch: 5, sharp: { major: 'F', minor: 'Dm', diminished: 'E' }, flat: { major: 'F', minor: 'Dm', diminished: 'E' } }
    ];
    const diatonicChordsMap = {
        'C': {majors: ['C', 'F', 'G'], minors: ['Dm', 'Em', 'Am'], diminished: 'B'},
        'G': {majors: ['G', 'C', 'D'], minors: ['Am', 'Bm', 'Em'], diminished: 'F#'},
        'D': {majors: ['D', 'G', 'A'], minors: ['Em', 'F#m', 'Bm'], diminished: 'C#'},
        'A': {majors: ['A', 'D', 'E'], minors: ['Bm', 'C#m', 'F#m'], diminished: 'G#'},
        'E': {majors: ['E', 'A', 'B'], minors: ['F#m', 'G#m', 'C#m'], diminished: 'D#'},
        'B': {majors: ['B', 'E', 'F#'], minors: ['C#m', 'D#m', 'G#m'], diminished: 'A#'},
        'F#': {majors: ['F#', 'B', 'C#'], minors: ['G#m', 'A#m', 'D#m'], diminished: 'E#'},
        'Gb': {majors: ['Gb', 'Cb', 'Db'], minors: ['Abm', 'Bbm', 'Ebm'], diminished: 'F'},
        'Db': {majors: ['Db', 'Gb', 'Ab'], minors: ['Ebm', 'Fm', 'Bbm'], diminished: 'C'},
        'Ab': {majors: ['Ab', 'Db', 'Eb'], minors: ['Bbm', 'Cm', 'Fm'], diminished: 'G'},
        'Eb': {majors: ['Eb', 'Ab', 'Bb'], minors: ['Fm', 'Gm', 'Cm'], diminished: 'D'},
        'Bb': {majors: ['Bb', 'Eb', 'F'], minors: ['Cm', 'Dm', 'Gm'], diminished: 'A'},
        'F': {majors: ['F', 'Bb', 'C'], minors: ['Gm', 'Am', 'Dm'], diminished: 'E'}
    };
    const sharpKeys = ['G', 'D', 'A', 'E', 'B', 'F#'];
    const radii = { major: 310, minor: 230, diminished: 150 };
    const keyElements = [];
    let currentProgression = [];
    let transportLoop;

    function getChordNotes(rootNote, type) {
        const pureRootNote = rootNote.replace('m', ''); // Limpiar la 'm' para el cálculo
        const rootPitch = Tone.Frequency(pureRootNote + "4").toMidi();
        let intervals;
        if (type === 'major') intervals = [0, 4, 7];
        else if (type === 'minor') intervals = [0, 3, 7];
        else intervals = [0, 3, 6]; // diminished
        return intervals.map(i => Tone.Frequency(rootPitch + i, "midi").toNote());
    }

    function addChordToProgression(rootNote, type) {
        let display = rootNote.replace('b', '♭').replace('#', '♯');
        if (type === 'diminished') display += '°';
        // No longer need to add 'm' as it's part of the rootNote (e.g., 'Am')
        currentProgression.push({ root: rootNote, type: type, notes: getChordNotes(rootNote, type), display: display });
        updateProgressionDisplay();
    }

    function updateProgressionDisplay() {
        progressionBuilder.innerHTML = '';
        currentProgression.forEach((chord, index) => {
            const chordEl = document.createElement('div');
            chordEl.className = 'progression-chord';
            chordEl.innerHTML = `<div class="chord-name-display">${chord.display}</div>`;
            chordEl.onclick = () => { currentProgression.splice(index, 1); updateProgressionDisplay(); };
            progressionBuilder.appendChild(chordEl);
        });
    }

    function createKeyElement(keyInfo, type, radius, index) {
        const keyElement = document.createElement('div');
        keyElement.className = `key-base key-${type}`;
        keyElement.dataset.pitch = keysData[index].pitch;
        keyElement.dataset.type = type;
        
        const textElement = document.createElement('div');
        textElement.className = 'key-text';
        keyElement.appendChild(textElement);

        keyElement.addEventListener('click', (e) => {
            e.stopPropagation();
            sampler.releaseAll();
            const keyName = keyElement.dataset.key;
            const notes = getChordNotes(keyName, type);
            sampler.triggerAttackRelease(notes, '2n');
            keyElement.classList.add('active');
            setTimeout(() => keyElement.classList.remove('active'), 300);
            addChordToProgression(keyName, type);
        });
        circleContainer.appendChild(keyElement);
        keyElements.push({ element: keyElement, radius: radius, index: index });
    }

    function rotateCircle(selectedKey = 'C') {
        const selectedIndex = keysData.findIndex(k => k.sharp.major === selectedKey || k.flat.major === selectedKey);
        const isSharpContext = sharpKeys.includes(selectedKey);
        const diatonicData = diatonicChordsMap[selectedKey];
        const diatonicRoots = diatonicData ? {
            majors: diatonicData.majors,
            minors: diatonicData.minors,
            diminished: diatonicData.diminished
        } : null;

        keyElements.forEach(item => {
            const keyElement = item.element;
            const pitch = parseInt(keyElement.dataset.pitch);
            const type = keyElement.dataset.type;
            const keyDataForPitch = keysData.find(k => k.pitch === pitch);
            if (!keyDataForPitch) return;

            // 1. Relabel
            const keyName = isSharpContext ? keyDataForPitch.sharp[type] : keyDataForPitch.flat[type];
            keyElement.dataset.key = keyName;
            let text = keyName.replace('b', '♭').replace('#', '♯');
            if (type === 'diminished') text += '°';
            keyElement.querySelector('.key-text').textContent = text;

            // 2. Highlight and Position
            let isDiatonic = false;
            if (diatonicRoots) {
                if (type === 'major' && diatonicRoots.majors.includes(keyName)) isDiatonic = true;
                else if (type === 'minor' && diatonicRoots.minors.includes(keyName)) isDiatonic = true;
                else if (type === 'diminished' && diatonicRoots.diminished === keyName) isDiatonic = true;
            }

            const angle = ((item.index - selectedIndex) / keysData.length) * 2 * Math.PI - (Math.PI / 2);
            const x = item.radius * Math.cos(angle);
            const y = item.radius * Math.sin(angle);
            const posTransform = `translate(${x}px, ${y}px)`;
            keyElement.style.setProperty('--transform-pos', posTransform);

            if (isDiatonic) {
                keyElement.classList.add('diatonic');
                keyElement.style.transform = `${posTransform} scale(1.05)`;
            } else {
                keyElement.classList.remove('diatonic');
                keyElement.style.transform = posTransform;
            }
        });
    }

    function initCircle() {
        const centerControls = document.createElement('div');
        centerControls.className = 'center-controls';
        centerControls.innerHTML = `<label for="key-selector">Tonalidad</label><select id="key-selector"></select>`;
        circleContainer.appendChild(centerControls);
        const keySelector = document.getElementById('key-selector');

        keysData.forEach((data, i) => {
            createKeyElement(data, 'major', radii.major, i);
            createKeyElement(data, 'minor', radii.minor, i);
            createKeyElement(data, 'diminished', radii.diminished, i);
        });
        const selectorKeys = ['C', 'G', 'D', 'A', 'E', 'B', 'F#', 'Db', 'Ab', 'Eb', 'Bb', 'F'];
        selectorKeys.forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = key.replace('b', '♭').replace('#', '♯');
            keySelector.appendChild(option);
        });
        keySelector.addEventListener('change', (e) => rotateCircle(e.target.value));
    }

    function togglePlayback() {
        if (Tone.Transport.state === 'started') {
            Tone.Transport.stop();
            if (transportLoop) transportLoop.dispose();
            playStopBtn.innerHTML = playIconSVG;
            playStopBtn.classList.remove('playing');
        } else {
            if (currentProgression.length === 0) return;
            Tone.Transport.bpm.value = 120;
            let chordIndex = 0;
            transportLoop = new Tone.Loop(time => {
                const chord = currentProgression[chordIndex % currentProgression.length];
                sampler.triggerAttackRelease(chord.notes, '1n', time);
                const chordElements = progressionBuilder.childNodes;
                chordElements.forEach(el => el.classList.remove('playing-chord'));
                if(chordElements[chordIndex % currentProgression.length]){
                    chordElements[chordIndex % currentProgression.length].classList.add('playing-chord');
                }
                chordIndex++;
            }, "1n").start(0);
            Tone.Transport.start();
            playStopBtn.innerHTML = stopIconSVG;
            playStopBtn.classList.add('playing');
        }
    }

    clearProgressionBtn.addEventListener('click', () => {
        if (Tone.Transport.state === 'started') togglePlayback();
        currentProgression = [];
        updateProgressionDisplay();
    });
    playStopBtn.addEventListener('click', togglePlayback);

    initCircle();
    rotateCircle('C');
});
</script>
</body>
</html>