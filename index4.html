<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrenador de Tonalidades</title>
    <link rel="shortcut icon" href="assets/images/iconapp.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/cards.css">
    <style>
        body {
            touch-action: manipulation;
        }
        .main-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 90vh;
            padding-top: 50px;
        }
        .circle-container {
            position: relative;
            width: 400px;
            height: 400px;
            margin: 20px auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .tonality {
            position: absolute;
            width: 80px;
            height: 80px;
            background-color: #333;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8em;
            font-weight: bold;
            border: 3px solid #555;
            transition: all 0.3s ease;
        }
        .tonality.active {
            background-color: #bb86fc;
            border-color: #fff;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(187, 134, 252, 0.7);
        }
        .center-display {
            position: absolute;
            text-align: center;
        }
        #current-tonality-display {
            font-size: 6em;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.7);
        }
        #timer-display {
            font-size: 2em;
            color: #aaa;
            margin-top: 10px;
        }
        .controls-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 10px;
        }
        .timer-controls {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .control-button {
            background-color: #3a3a3a;
            color: #f0f0f0;
            border: 2px solid #555;
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            margin: 5px;
        }
        .control-button:hover {
            background-color: #4a4a4a;
        }
        .control-button.selected {
            background-color: #bb86fc;
            border-color: #f0f0f0;
        }
        #startStopButton {
            background-color: #198754; /* Verde para Iniciar */
            margin-left: 20px;
        }
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); color: white; display: none;
            justify-content: center; align-items: center; font-size: 2em; z-index: 1000;
        }
    </style>
</head>
<body>
<div id="loading-overlay">Cargando audios...</div>
<div class="wrapper">
    <header>
        <nav>
            <ul>
                <li><a href="index.html">Generador de progresiones</a></li>
                <li><a href="Index2.html">Generador de partituras</a></li>
                <li><a href="Index3.html">Generador de ondas</a></li>
                <li><a href="#" class="active-nav-link">Entrenador de Tonalidades</a></li>
                <li><a href="index5.html">Generador de cifrados</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <div class="main-container">
            <div class="circle-container" id="tonality-circle">
                <div class="center-display">
                    <div id="current-tonality-display">C</div>
                    <div id="timer-display">00:30</div>
                </div>
            </div>
            <div class="controls-wrapper">
                <div class="timer-controls">
                    <button class="control-button" data-duration="10">10s</button>
                    <button class="control-button selected" data-duration="30">30s</button>
                    <button class="control-button" data-duration="60">1m</button>
                    <button id="startStopButton" class="control-button">Iniciar</button>
                </div>
            </div>
        </div>
    </main>
</div>
<footer><p> </p></footer>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const circle = document.getElementById('tonality-circle');
    const currentTonalityDisplay = document.getElementById('current-tonality-display');
    const timerDisplay = document.getElementById('timer-display');
    const timerButtons = document.querySelectorAll('.timer-controls .control-button[data-duration]');
    const startStopButton = document.getElementById('startStopButton');
    const loadingOverlay = document.getElementById('loading-overlay');

    const tonalities = ['C', 'G', 'D', 'A', 'E', 'B', 'F#', 'Db', 'Ab', 'Eb', 'Bb', 'F'];
    const acordes = {
        'C': ['C4', 'E4', 'G4'], 'G': ['G4', 'B4', 'D5'], 'D': ['D4', 'F#4', 'A4'],
        'A': ['A3', 'C#4', 'E4'], 'E': ['E3', 'G#3', 'B3'], 'B': ['B3', 'D#4', 'F#4'],
        'F#': ['F#3', 'A#3', 'C#4'],'Db': ['Db4', 'F4', 'Ab4'],'Ab': ['Ab3', 'C4', 'Eb4'],
        'Eb': ['Eb3', 'G3', 'Bb3'], 'Bb': ['Bb3', 'D4', 'F4'], 'F': ['F3', 'A3', 'C4']
    };

    let audioContext;
    const audioBuffers = {};
    let currentlyPlayingNodes = [];
    const AUDIO_DURATION = 8.0;
    const QUICK_FADE_OUT = 0.1;
    const loopFadeOutTime = 4.0;
    const loopFadeInTime = 4.0;
    let previousTonality = null;

    let loopTimeoutId = null;
    let currentTonalityIndex = 0;
    let duration = 30;
    let countdown;
    let mainTimerId = null;
    let isTimerRunning = false;
    let isAudioReady = false;

    function formatNoteForFile(note) {
        const noteName = note.slice(0, -1);
        const octave = note.slice(-1);
        const fileNoteMap = {
            'C#': 'cs', 'Db': 'cs',
            'D#': 'ds', 'Eb': 'ds',
            'F#': 'fs', 'Gb': 'fs',
            'G#': 'gs', 'Ab': 'gs',
            'A#': 'as', 'Bb': 'as'
        };
        const fileNote = fileNoteMap[noteName] || noteName.toLowerCase();
        return fileNote + octave;
    }

    async function initAudio() {
        if (audioContext) return;
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        loadingOverlay.style.display = 'flex';
        const allNotes = [...new Set(Object.values(acordes).flat())];
        const promises = allNotes.map(note => {
            const url = `assets/audios/${formatNoteForFile(note)}.wav`;
            return fetch(url)
                .then(response => response.arrayBuffer())
                .then(buffer => audioContext.decodeAudioData(buffer))
                .then(decodedData => {
                    audioBuffers[note] = decodedData;
                });
        });

        await Promise.all(promises);
        isAudioReady = true;
        loadingOverlay.style.display = 'none';
    }

    function playChord(tonality) {
        if (!isAudioReady || !audioContext) return;

        clearTimeout(loopTimeoutId);
        const now = audioContext.currentTime;

        const isTonalityChange = (previousTonality !== tonality && previousTonality !== null);
        const fadeOut = isTonalityChange ? QUICK_FADE_OUT : loopFadeOutTime;

        currentlyPlayingNodes.forEach(node => {
            node.gainNode.gain.linearRampToValueAtTime(0, now + fadeOut);
            node.source.stop(now + fadeOut);
        });

        const newNodes = [];
        const notes = acordes[tonality];
        if (notes) {
            notes.forEach(note => {
                const buffer = audioBuffers[note];
                if (!buffer) return;

                const source = audioContext.createBufferSource();
                source.buffer = buffer;

                const gainNode = audioContext.createGain();
                gainNode.gain.setValueAtTime(0, now);
                gainNode.gain.linearRampToValueAtTime(1, now + loopFadeInTime);

                source.connect(gainNode).connect(audioContext.destination);
                source.start(now);
                newNodes.push({ source, gainNode });
            });
        }
        currentlyPlayingNodes = newNodes;
        previousTonality = tonality;

        const nextLoopTime = (AUDIO_DURATION - loopFadeOutTime) * 1000;
        if (nextLoopTime > 0) {
             loopTimeoutId = setTimeout(() => playChord(tonality), nextLoopTime);
        }
    }

    function stopAllSounds() {
        if (!audioContext) return;
        clearTimeout(loopTimeoutId);
        const now = audioContext.currentTime;
        currentlyPlayingNodes.forEach(node => {
            node.gainNode.gain.linearRampToValueAtTime(0, now + QUICK_FADE_OUT);
            node.source.stop(now + QUICK_FADE_OUT);
        });
        currentlyPlayingNodes = [];
        previousTonality = null;
    }

    function renderCircle() {
        const radius = 200;
        tonalities.forEach((tonality, i) => {
            const angle = (i / tonalities.length) * 2 * Math.PI - (Math.PI / 2);
            const x = radius * Math.cos(angle);
            const y = radius * Math.sin(angle);
            const el = document.createElement('div');
            el.className = 'tonality';
            el.textContent = tonality.replace('b', '♭').replace('#', '♯');
            el.dataset.tonality = tonality;
            el.style.transform = `translate(${x}px, ${y}px)`;
            if (i === 0) el.classList.add('active');
            circle.appendChild(el);
        });
    }

    function updateDisplay() {
        document.querySelectorAll('.tonality').forEach(el => {
            el.classList.remove('active');
            if (el.dataset.tonality === tonalities[currentTonalityIndex]) {
                el.classList.add('active');
            }
        });
        const currentTonality = tonalities[currentTonalityIndex];
        currentTonalityDisplay.textContent = currentTonality.replace('b', '♭').replace('#', '♯');
    }

    function switchToNextTonality() {
        currentTonalityIndex = (currentTonalityIndex + 1) % tonalities.length;
        updateDisplay();
        playChord(tonalities[currentTonalityIndex]);
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        return `${mins}:${secs}`;
    }

    async function startTimer() {
        if (isTimerRunning) return;
        if (!isAudioReady) {
            await initAudio();
        }

        isTimerRunning = true;
        startStopButton.textContent = 'Detener';
        startStopButton.style.backgroundColor = '#dc3545';

        playChord(tonalities[currentTonalityIndex]);

        clearInterval(mainTimerId);
        countdown = duration;
        timerDisplay.textContent = formatTime(countdown);

        mainTimerId = setInterval(() => {
            countdown--;
            timerDisplay.textContent = formatTime(countdown);
            if (countdown <= 0) {
                switchToNextTonality();
                countdown = duration;
            }
        }, 1000);
    }

    function stopTimer() {
        if (!isTimerRunning) return;
        isTimerRunning = false;
        clearInterval(mainTimerId);
        stopAllSounds();
        startStopButton.textContent = 'Iniciar';
        startStopButton.style.backgroundColor = '#198754';
    }

    timerButtons.forEach(button => {
        button.addEventListener('click', () => {
            duration = parseInt(button.dataset.duration, 10);
            timerDisplay.textContent = formatTime(duration);
            timerButtons.forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            if (isTimerRunning) {
                clearInterval(mainTimerId);
                countdown = duration;
                timerDisplay.textContent = formatTime(duration);
                mainTimerId = setInterval(() => {
                    countdown--;
                    timerDisplay.textContent = formatTime(countdown);
                    if (countdown <= 0) {
                        switchToNextTonality();
                        countdown = duration;
                    }
                }, 1000);
            }
        });
    });

    startStopButton.addEventListener('click', () => {
        if (isTimerRunning) {
            stopTimer();
        } else {
            startTimer();
        }
    });

    // Inicialización
    renderCircle();
    timerDisplay.textContent = formatTime(duration);
});
</script>
</body>
</html>
